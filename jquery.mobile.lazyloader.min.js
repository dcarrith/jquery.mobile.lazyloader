(function(b,o){b.widget("mobile.lazyloader",b.mobile.widget,{_defaultOptions:{threshold:360,retrieve:20,retrieved:20,bubbles:!1,offset:0},_defaultParameters:{retrieve:20,retrieved:20,offset:0},_defaultSettings:{pageId:"",templateType:"",templatePrecompiled:!1,templateId:"",template:"",mainId:"",progressDivId:"",moreUrl:"",clearUrl:""},_defaultSelectors:{main:"ul",single:"ul li",bottom:'[data-role="list-divider"]'},_handleScrollStartJustFired:!1,_handleScrollStopJustFired:!1,_mouseWheelEventJustFired:!1,
_handleScrollStartTimeoutId:null,_handleScrollStopTimeoutId:null,_mouseWheelTimeoutId:null,_instances:{},_moreOutstandingPageId:null,_parameters:null,_settings:null,_selectors:null,timeoutOptions:{mousewheel:400,scrollstart:600,scrollstop:60,showprogress:200,scrolldown:400,immediately:0},_widgetName:"lazyloader",_widgetState:{busy:!1,done:!1},_create:function(){this._initialize(this._defaultOptions,this._defaultSettings,this._defaultParameters,this._defaultSelectors);this._bind()},_init:function(){},
_initialize:function(a,d,c,e){if("undefined"!=typeof a&&""!=a&&(this._widgetState.busy=!1,this._widgetState.done=!1,this._settings=b.extend(!0,this._settings,this._defaultSettings),this._settings=b.extend(!0,this._settings,d),"undefined"!==typeof this._settings.mainId&&""!==this._settings.mainId&&(this._defaultSelectors.main="#"+this._settings.mainId,this._defaultSelectors.single="#"+this._settings.mainId+" li",this._defaultSelectors.bottom='[data-role="list-divider"]'),"undefined"!==typeof this._settings.pageId&&
""!==this._settings.pageId&&(this._settings.totalHeight=b("#"+this._settings.pageId).height()),this._selectors=b.extend(!0,this._selectors,this._defaultSelectors),this._selectors=b.extend(!0,this._selectors,e),this._parameters=b.extend(!0,this._parameters,this._defaultParameters),this._parameters=b.extend(!0,this._parameters,c),this.options=b.extend(!0,this.options,this._defaultOptions),this.options=b.extend(!0,this.options,a),a=d.pageId,"undefined "!=typeof a&&""!=a&&!this._instances[a]))optionsAsString=
JSON.stringify(this.options),"undefined"!=typeof this._settings.templateId&&""!=this._settings.templateId&&(d=b("#"+this._settings.templateId).html(),c="",e=this._settings.templatePrecompiled,"undefined"!=typeof this._settings.templateType&&""!=this._settings.templateType&&(c=this._settings.templateType),this._settings.template="dust"===c&&""!==d&&!e?dust.compile(d,this._settings.templateId):d),settingsAsString=JSON.stringify(this._settings),selectorsAsString=JSON.stringify(this._selectors),this._instances[a]=
[],this._instances[a].options=b.parseJSON(optionsAsString),this._instances[a].settings=b.parseJSON(settingsAsString),this._instances[a].selectors=b.parseJSON(selectorsAsString)},_bind:function(){b("body").bind("scrollstart",b.proxy(this._handleScrollStart,this));b("body").bind("scrollstop",b.proxy(this._handleScrollStop,this));/Firefox/i.test(navigator.userAgent)?b(window).bind("DOMMouseScroll",b.proxy(this._handleMouseWheelEvent,this)):"undefined"!=typeof this._selectors&&null!=this._selectors&&
""!=this._selectors&&"undefined"!=typeof this._selectors.main&&(b(this._selectors.main).attachEvent?b(window).bind("onmousewheel",b.proxy(this._handleMouseWheelEvent,this)):b(window).bind("mousewheel",b.proxy(this._handleMouseWheelEvent,this)))},_unbind:function(){b("body").unbind("scrollstart",this._handleScrollStart);b("body").unbind("scrollstop",this._handleScrollStop);/Firefox/i.test(navigator.userAgent)?b(window).unbind("DOMMouseScroll",this._handleMouseWheelEvent):"undefined"!=typeof this._selectors&&
null!=this._selectors&&""!=this._selectors&&"undefined"!=typeof this._selectors.main&&(b(this._selectors.main).attachEvent?b(window).unbind("onmousewheel",this._handleMouseWheelEvent):b(window).unbind("mousewheel",this._handleMouseWheelEvent))},destroy:function(){this._unbind();this._defaultParameters=this._defaultSettings=this._defaultOptions=this._widgetState=this._mouseWheelTimeoutId=this._handleScrollStopTimeoutId=this._handleScrollStartTimeoutId=this._mouseWheelEventJustFired=this._handleScrollStopJustFired=
this._handleScrollStartJustFired=this._instances=this._parameters=this._settings=this.timeoutOptions=this.options=null;b.Widget.prototype.destroy.apply(this)},_check:function(a){var a=this.options.threshold||a,d,c,e;c=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop;d=this._instances[this._settings.pageId]?this._instances[this._settings.pageId].settings.totalHeight:this._settings.totalHeight;e=b(window).height();return d-a<=c+e},_load:function(a){typeof this._settings.pageId!=
o&&""!=this._settings.pageId&&(b(".ui-page-active").attr("id")==this._settings.pageId?!this._widgetState.busy&&!this._widgetState.done?(this._moreOutstandingPageId=this._settings.pageId,$that=this,setTimeout(function(){$that._moreOutstandingPageId==$that._settings.pageId&&($that._check($that.options.threshold)||0===a)&&b("#"+$that._settings.progressDivId).show($that.timeoutOptions.showprogress,function(){moreUrl=$that._settings.moreUrl;var a="",c=0;$that._instances[$that._settings.pageId]?($that._parameters.retrieve=
$that._instances[$that._settings.pageId].options.retrieve,$that._parameters.retrieved=$that._instances[$that._settings.pageId].options.retrieved,$that._parameters.offset=$that._instances[$that._settings.pageId].options.offset):($that._parameters.retrieve=$that.options.retrieve,$that._parameters.retrieved=$that.options.retrieved,$that._parameters.offset=$that.options.offset);if("undefined"!=typeof $that._settings.pageId&&""!=$that._settings.pageId){var e=b("#"+$that._settings.pageId).find('[type="hidden"]');
for(i=0;i<e.length;i++){var g=b(e).get(i);"undefined"!=typeof b(g).attr("id")&&""!=b(g).attr("id")&&($that._parameters[b(g).attr("id")]=escape(b(g).val()))}}for(var n in $that._parameters)a=0==c?a+(n+"="+$that._parameters[n]):a+("&"+n+"="+$that._parameters[n]),c+=1;b.ajax({type:"POST",url:moreUrl,async:!0,data:a,success:function(a){var c=b.parseJSON(a),a=c.data[0].count,d="",e="",f="",j="",l="",g=false,k="",m="",h=e="";if(a>0){k=$that._selectors.main;m=$that._selectors.single;e=$that._selectors.bottom;
h=$that._getBottomElement(k,e);if(typeof c.data[0].html!="undefined"&&c.data[0].html!=""){d=c.data[0].html;h?b(m).last().before(d):b(k).append(d)}else{if($that._instances[$that._settings.pageId]){if(typeof $that._instances[$that._settings.pageId].settings.templateId!="undefined"&&$that._instances[$that._settings.pageId].settings.templateId!=""){j=$that._instances[$that._settings.pageId].settings.templateId;if(typeof $that._instances[$that._settings.pageId].settings.templateType!="undefined"&&$that._instances[$that._settings.pageId].settings.templateType!=
"")l=$that._instances[$that._settings.pageId].settings.templateType;if(typeof $that._instances[$that._settings.pageId].settings.template!="undefined"&&$that._instances[$that._settings.pageId].settings.template!="")f=$that._instances[$that._settings.pageId].settings.template}g=$that._instances[$that._settings.pageId].settings.templatePrecompiled}else{if(typeof $that._settings.templateId!="undefined"&&$that._settings.templateId!=""){j=$that._settings.templateId;if(typeof $that._settings.templateType!=
"undefined"&&$that._settings.templateType!="")l=$that._settings.templateType;if(typeof $that._settings.template!="undefined"&&$that._settings.template!="")f=$that._settings.template}g=$that._settings.templatePrecompiled}if(l!==""&&j!==""&&f!=="")if(l==="json2html"){e=c.data[0].json;h&&h.remove();b(k).json2html(e,b.parseJSON(f));h&&b(m).last().append(h)}else{e=c.data[0];switch(l){case "handlebars":f=g?Handlebars.templates[j+".tmpl"]:Handlebars.compile(f);d=f(e);break;case "icanhaz":ich.addTemplate("listitem",
f);d=ich.listitem(e,true);ich.clearAll();break;case "dust":if(g)dust.render(j,e,function(a,b){d=b});else{dust.loadSource(f);dust.render(j,e,function(a,b){d=b})}break;case "dot":f=doT.template(f);d=f(e)}h?b(m).last().before(d):b(k).append(d)}}b(k).listview("refresh");a=parseInt(a);c=b(m).first().next().height();if($that._instances[$that._settings.pageId]){f=$that._instances[$that._settings.pageId].settings.totalHeight;$that._instances[$that._settings.pageId].settings.totalHeight=f+c*a}else{f=$that._settings.totalHeight;
$that._settings.totalHeight=f+c*a}$that._instances[$that._settings.pageId].options.retrieved=$that._instances[$that._settings.pageId].options.retrieved+a;if(a<$that.options.retrieve||$that.options.retrieve=="all"){$that._widgetState.done=true;$that._triggerEvent("alldone","_load")}}else{$that._widgetState.done=true;$that._triggerEvent("alldone","_load")}b("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false});$that._triggerEvent("doneloading","_load")},error:function(a){$that._triggerEvent("error",
"_load",a);b("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false})}})})},a)):this._widgetState.done?$that._triggerEvent("alldone","_load"):this._widgetState.busy&&$that._triggerEvent("busy","_load"):b("#"+this._settings.progressDivId).hide(250,function(){"undefined"!=typeof this._widgetState&&(this._widgetState.busy=!1)}))},_getBottomElement:function(a,d){var c=b(a).last().find(d);switch(c.length){case 2:c=c.last();break;default:c=null}return"undefined"!=typeof c&&
null!=c&&""!=c&&"null"!=c?c:!1},_handleMouseWheelEvent:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._mouseWheelEventJustFired=!0;this._load(this.timeoutOptions.mousewheel);var a=this;this._mouseWheelTimeoutId=setTimeout(function(){a._mouseWheelEventJustFired=!1},1E3)}},_handleScrollStart:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._handleScrollStartJustFired=
!0;this._load(this.timeoutOptions.scrollstart);var a=this;this._handleScrollStartTimeoutId=setTimeout(function(){a._handleScrollStartJustFired=!1},1200)}},_handleScrollStop:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._handleScrollStopJustFired=!0;this._load(this.timeoutOptions.scrollstop);var a=this;this._handleScrollStopTimeoutId=setTimeout(function(){a._handleScrollStopJustFired=!1},1200)}},loadMore:function(a){0===a?this._load(this.timeoutOptions.immediately):
this._load(this.timeoutOptions.scrolldown)},_setOption:function(a,d){this._instances[this._settings.pageId]&&this._instances[this._settings.pageId].options[a]&&(this._instances[this._settings.pageId].options[a]=d);b.Widget.prototype._setOption.apply(this,arguments)},refresh:function(a,d){if("parameters"==a){if("undefined"!=typeof this.options)for(var c in this._parameters)"undefined"!=typeof this.options[c]&&(this._parameters[c]=this.options[c])}else"parameter"==a&&(c=d,"undefined"!=typeof this.options[c]&&
(this._parameters[c]=this.options[c]));c=JSON.stringify(this._parameters);this._parameters=b.parseJSON(c)},reInitialize:function(a,b,c,e){this._initialize(a,b,c,e)},reset:function(a){var d=this;b.ajax({type:"POST",url:d._settings.clearUrl,async:!0,data:"section="+a,success:function(b){parseInt(b)&&(d.options.retrieved=d._defaultOptions.retrieved,d._widgetState.done=!1,"undefined"!=typeof d._instances[a]&&delete d._instances[a],d._triggerEvent("reset","reset","All session variables for the '"+a+"' page and the lazyloader instance variables have been cleared."))},
error:function(a){d._triggerEvent("error","reset",a);b("#"+d._settings.progressDivId).hide(250,function(){d._widgetState.busy=!1})}})},resetAll:function(){var a=this;b.ajax({type:"POST",url:a._settings.clearUrl,async:!0,data:"",success:function(b){if(parseInt(b)){for(pageId in a._instances)delete a._instances[pageId];a.options.retrieved=a._defaultOptions.retrieved;a._widgetState.done=!1;a._widgetState.busy=!1;a._triggerEvent("resetall","resetAll","All session variables for all pages currently being tracked by the lazyloader have been cleared.")}}})},
_triggerEvent:function(a,b,c){c=c||"";switch(a){case "error":case "resetall":this._trigger(a,{type:"lazyloader"+a,"function":b,message:c,settings:this._settings,options:this.options,parameters:this._parameters});break;default:this._trigger(a,{type:"lazyloader"+a,"function":b,message:c,pageId:this._settings.pageId,mainId:this._settings.mainId,loaded:this.options.retrieved})}}});b(document).bind("pagecreate create",function(a){b.mobile.lazyloader.prototype.enhanceWithin(a.target)})})(jQuery);
